/**
 * jMID.min.js v0.2.1
 *
 * A javascript library for reading, manipulating, writing, and timing MIDI files
 * @author Steven Sojka - Thursday, March 07, 2013
 *
 * MIT Licensed
 */
var jMID=function(d){d.EventTypes={META:255,SYSEX:240,DIVIDED_SYSEX:247};d.SubEventTypes={SEQUENCE_NUMBER:0,TEXT:1,COPYRIGHT_NOTICE:2,TRACK_NAME:3,INSTRUMENT_NAME:4,LYRICS:5,MARKER:6,CUE_POINT:7,MIDI_CHANNEL_PREFIX:32,END_OF_TRACK:47,SET_TEMPO:81,SMPTE_OFFSET:84,TIME_SIGNATURE:88,KEY_SIGNATURE:89,SEQUENCER_SPECIFIC:127,NOTE_OFF:8,NOTE_ON:9,NOTE_AFTER_TOUCH:10,CONTROLLER:11,PROGRAM_CHANGE:12,CHANNEL_AFTER_TOUCH:13,PITCH_BEND:14};return d}(jMID||{}),jMID=function(d){var b=Array.prototype;d.Util={isObject:function(a){return a===
Object(a)},asciiToHex:function(a){for(var e="",c=0,b=a.length;c<b;c++)e+=a.charCodeAt(c).toString(16);return e},hexToAscii:function(a){return c},stringToBytes:function(a,c){if(c)for(;a.length/2<c;)a="0"+a;for(var b=[],
f=a.length-1;0<=f;f-=2)b.unshift(parseInt(0===f?a[f]:a[f-1]+a[f],16));return b},writeVarInt:function(a){for(var c=a&127;a>>=7;)c<<=8,c|=a&127|128;for(a=[];;)if(a.push(c&255),c&128)c>>=8;else break;return a},asyncLoop:function(a){var c=-1,b=function(){++c===a.length?a.callback():a.func(b,c)};b()},getType:function(a){var c=d.SubEventTypes;switch(a){case "sequenceNumber":return c.SEQUENCER_NUMBER;case "text":return c.TEXT;case "copyrightNotice":return c.COPYRIGHT_NOTICE;case "trackName":return c.TRACK_NAME;
case "instrumentName":return c.INSTRUMENT_NAME;case "lyrics":return c.LYRICS;case "marker":return c.MARKER;case "cuePoint":return c.CUE_POINT;case "midiChannelPrefix":return c.MIDI_CHANNEL_PREFIX;case "endOfTrack":return c.END_OF_TRACK;case "setTempo":return c.SET_TEMPO;case "smpteOffset":return c.SMPTE_OFFSET;case "timeSignature":return c.TIME_SIGNATURE;case "sequencerSpecific":return c.SEQUENCER_SPECIFIC;case "noteOff":return c.NOTE_OFF;case "noteOn":return c.NOTE_ON;case "noteAfterTouch":return c.NOTE_AFTER_TOUCH;
case "controller":return c.CONTROLLER;case "programChange":return c.PROGRAM_CHANGE;case "channelAfterTouch":return c.CHANNEL_AFTER_TOUCH;case "pitchBend":return c.PITCH_BEND}},forAllEvents:function(a,c){var d=this,f=b.slice.call(arguments);f.splice(0,2);this.forEachTrack(a,function(a,b){d.forEachEvent.apply(d,[a,c,b].concat(f))})},forAllNotes:function(a,c){var d=this,f=b.slice.call(arguments);f.splice(0,2);this.forEachTrack(a,function(a,b){d.forEachNote.apply(d,[a,c,b].concat(f))})},forEachTrack:function(a,
c){var d=b.slice.call(arguments);d.splice(0,2);for(var f=0,i=a.length;f<i;f++)c.apply(this,[a[f],f].concat(d))},forEachNote:function(a,c){var d=b.slice.call(arguments);d.splice(0,2);for(var f=0,i=a.notes.length;f<i;f++)c.apply(this,[a.notes[f],f].concat(d))},forEachEvent:function(a,c){var d=b.slice.call(arguments);d.splice(0,2);for(var f=0,i=a.events.length;f<i;f++)c.apply(this,[a.events[f],f].concat(d))},inRange:function(a,c,b){return a>=c&&a<=b}};for(var a="Arguments Function String Number Date RegExp".split(" "),
c=a.length-1;0<=c;c--)(function(a){d.Util["is"+a]=function(c){return toString.call(c)=="[object "+a+"]"}})(a[c]);return d}(jMID||{}),jMID=function(d){d.Emitter=function(){};d.Emitter.prototype={on:function(b,a){var c=b.split(" ");this.__events=this.__events||{};for(var d=0,e=c.length;d<e;d++)this.__events[c[d]]=this.__events[c[d]]||[],this.__events[c[d]].push(a)},off:function(b,a){this.__events=this.__events||{};b in this.__events&&this.__events[b].splice(this.__events[b].indexOf(a),1)},trigger:function(b){this.__events=
this.__events||{};if(b in this.__events)for(var a=0,c=this.__events[b].length;a<c;a++)this.__events[b][a].apply(this,Array.prototype.slice.call(arguments,1))}};d.Emitter.register=function(b){for(var a in d.Emitter.prototype)d.Emitter.prototype.hasOwnProperty(a)&&(b.prototype[a]=d.Emitter.prototype[a])};return d}(jMID||{}),jMID=function(d){d.Event=function(b){this.track=null;for(var a in b)b.hasOwnProperty(a)&&(this[a]=b[a])};d.Event.prototype={set:function(){var b=d.Util,a=arguments;if(b.isObject(a[0]))for(var c in a[0])a[0].hasOwnProperty(c)&&
(this[c]=a[0][c]);else if(b.isString(a[0]))this[a[0]]=a[1];else return null},get:function(b){return this[b]},encode:function(){if("meta"===this.type){var b=[];Array.prototype.push.apply(b,d.Util.writeVarInt(this.deltaTime));b.push(255,d.Util.getType(this.subtype));switch(this.subtype){case "sequenceNumber":b.push(1,this.number);break;case "midiChannelPrefix":b.push(1,this.channel);break;case "setTempo":b.push(3,(this.microsecondsPerBeat&16711680)>>16,(this.microsecondsPerBeat&65280)>>8,this.microsecondsPerBeat&
255);break;case "smpteOffset":b.push(5,this.hourByte,this.min,this.sec,this.frame,this.subframe);break;case "timeSignature":b.push(4,this.numerator,Math.log(this.denominator)/Math.log(2),this.metronome,this.thirtyseconds);break;case "keySignature":b.push(2,this.key,this.scale);break;case "copyrightNotice":case "text":case "trackName":case "instrumentName":case "lyrics":case "marker":case "cuePoint":var a=this.text.split("");Array.prototype.push.apply(b,[a.length].concat(a));break;case "sequencerSpecific":case "unknown":b.push(1,
this.data);break;case "endOfTrack":b.push(0)}return b}b=[];a=d.Util.getType(this.subtype);a=parseInt(a.toString(16)+this.channel.toString(16),16);Array.prototype.push.apply(b,d.Util.writeVarInt(this.deltaTime));b.push(a);switch(this.subtype){case "noteOn":case "noteOff":b.push(this.noteNumber,this.velocity);break;case "noteAfterTouch":b.push(this.noteNumber,this.amount);break;case "controller":b.push(this.controllerType,this.value);break;case "programChange":byteArry.push(this.programNumber);break;
case "channelAfterTouch":b.push(this.amount);break;case "pitchBend":b.push(this.course,this.fine)}return b},remove:function(){null!==this.track&&this.track.removeEvent(this)}};d.Emitter&&d.Emitter.register(d.Event);return d}(jMID||{}),jMID=function(d){var b=function(a){for(var c,b=Array.prototype.slice.call(arguments,1),d=b.length,g;d&&this[a].length;)for(c=b[--d];-1!==(g=this[a].indexOf(c));)this[a].splice(g,1);return this};d.Track=function(a){this.events=[];this.notes=[];this.timing={MicroSPB:5E5,
MSPQN:500,MSPT:500/960};for(var c in a)a.hasOwnProperty(c)&&(this[c]=a[c]);this.processNotes()};d.Track.prototype={pushEvent:function(a){this.events.push(a);return this},pushNote:function(a){this.notes.push(a);return this},getEvents:function(a){return"undefined"!==typeof a?0<=a&&a<this.events.length?this.events[a]:null:this.events},getNotes:function(a){return"undefined"!==typeof a?0<=a&&a<this.notes.length?this.notes[a]:null:this.notes},removeEvents:function(){return b.apply(this,["events"].concat(Array.prototype.slice.call(arguments)))},
removeNotes:function(){return b.apply(this,["notes"].concat(Array.prototype.slice.call(arguments)))},removeNote:function(a){b.call(this,"notes",a)},removeEvent:function(a){var c=this.events.indexOf(a),c=this.events[c];b.call(this,"events",a);c&&this.calculateDelta(c)},cloneEvents:function(){return this.events.slice(0)},cloneNotes:function(){return this.notes.slice(0)},hasEvent:function(a){return-1!==this.events.indexOf(a)},hasNote:function(){return-1!==this.notes.indexOf(notes)},insertEventAtTime:function(a){var c=
this.positionEvent(a);this.events[c+1]?this.calculateDelta(a,this.events[c+1]):this.calculateDelta(a)},insertNoteAtTime:function(a){this.positionNote(a)},encode:function(){for(var a=[],c=0,b=0,e=this.events.length;b<e;b++){var g=this.getEvents(b).encode(),c=c+g.length;Array.prototype.push.apply(a,g)}c=d.Util.stringToBytes(c.toString(16),4);return d.Util.bytesToString([77,84,114,107].concat(c,a))},adjustEventTime:function(a,c){var a=d.Util.isNumber(a)?this.events[a]:a,b=this.events.indexOf(a),e=this.events[b+
1];Math.round(c/this.timing.MSPT);a.time+=c;this.hasEvent(a)&&this.events.splice(b,1);b=this.positionEvent(a);this.calculateDelta(e,a,this.events[b+1])},positionEvent:function(a){if(0===this.events.length)return this.events.splice(0,0,a),0;for(var c=0,b=this.events.length;c<b&&a.time>this.events[c].time;c++);this.events.splice(c,0,a);return c},positionNote:function(a){var c=this.notes.indexOf(a);-1!==c&&this.notes.splice(c,1);if(0===this.notes.length)return this.notes.splice(0,0,a),0;for(var c=0,
b=this.notes.length;c<b&&a.start>this.notes[c].start;c++);this.notes.splice(c,0,a);return c},calculateDelta:function(){for(var a=Array.prototype.slice.call(arguments),c=0,b=a.length;c<b;c++){var d=a[c];if(d){var g=this.events.indexOf(d),g=this.events[g-1];d.deltaTime=g?Math.round((d.time-g.time)/this.timing.MSPT):Math.round(d.time/this.timing.MSPT)}}},switchEvents:function(a,c){var b=this.events.indexOf(a),d=this.events.indexOf(c);this.events.splice(d,1,a);this.events.splice(b,1,c)},processNotes:function(){var a=
{};this.notes=[];for(var c=0,b=this.events.length;c<b;c++){var e=this.events[c];"noteOn"===e.subtype?a[e.noteNumber]=e:"noteOff"===e.subtype&&e.noteNumber in a&&(new d.Note({noteOn:a[e.noteNumber],noteOff:e,track:this}),delete a[e.noteNumber])}},processChannelEventTimes:function(){for(var a=this.timing.MSPT,c=0,b=0,d=this.events.length;b<d;b++){var g=this.events[b],f=g.deltaTime*a;g.set("time",c+f);"endOfTrack"===g.subtype&&(this.duration=g.get("time"));c+=f}}};d.Emitter&&d.Emitter.register(d.Track);
return d}(jMID||{}),jMID=function(d){d.File=function(b){for(var a in b)b.hasOwnProperty(a)&&(this[a]=b[a]);this.timeSignature={beatsPerBar:4,beatValue:4};this.timing={MicroSPB:5E5,MSPQN:500,MSPT:500/960};this.header||(this.header={format:0,trackCount:1,ticksPerBeat:960});if(this.tracks){this.processMetaEvents();for(b=this.tracks.length-1;0<=b;b--)this.tracks[b].timing=this.timing;this.processChannelEventTimes();this.processNotes()}else this.tracks=[new d.Track],this.header.trackCount=1,this.calculateBPM()};
d.File.prototype={processMetaEvents:function(){for(var b=d.Query(this).filter("type:meta").not("subtype:endOfTrack, subtype:trackName").toArray(),a=0,c=b.length;a<c;a++)switch(b[a].subtype){case "timeSignature":this.timeSignature.beatsPerBar=b[a].numerator;this.timeSignature.beatValue=b[a].denominator;break;case "setTempo":this.timing.MicroSPB=b[a].microsecondsPerBeat}this.calculateBPM();this.timing.MSPQN=this.timing.MicroSPB/1E3;this.timing.MSPT=this.timing.MSPQN/this.header.ticksPerBeat},processChannelEventTimes:function(){for(var b=
0,a=this.tracks.length;b<a;b++)this.tracks[b].processChannelEventTimes();this.duration=Math.max.apply(Math,this.tracks.map(function(a){return a.duration}))},processNotes:function(){for(var b=0,a=this.tracks.length;b<a;b++)this.tracks[b].processNotes()},calculateBPM:function(){this.timing.BPM=6E7/this.timing.MicroSPB*(this.timeSignature.beatValue/4)},createTrack:function(b){this.tracks.push(new d.Track(b))},removeTrack:function(b){this.tracks.splice(b,1)},setTempo:function(b){this.timing.BPM=b;this.timing.MSPQN=
6E4*(1/b);this.timing.MicroSPB=1E3*this.timing.MSPQN;this.timing.MSPT=this.timing.MSPQN/this.header.ticksPerBeat;this.processChannelEventTimes()},getTrack:function(b){return this.tracks[b]},getHeader:function(){return this.header},encode:function(){return(new d.Encoder).encode(this)},base64Encode:function(){return btoa(this.encode())}};d.Emitter&&d.Emitter.register(d.File);return d}(jMID||{}),jMID=function(d){d.Note=function(a){this.track=null;this.length=0;a=a||{};this.noteOn=a.noteOn?a.noteOn:new d.Event({type:"channel",
subtype:"noteOn",deltaTime:0,time:a.time||0,velocity:a.velocity||90,noteNumber:a.noteNumber||32,track:a.track||null});this.noteOff=a.noteOff?a.noteOff:new d.Event({type:"channel",subtype:"noteOff",deltaTime:0,time:a.length?this.noteOn.time+a.length:this.noteOn.time+100,velocity:this.noteOn.velocity,noteNumber:this.noteOn.noteNumber,track:a.track||null});b.call(this);a.track&&(this.track=a.track,this.track.hasEvent(this.noteOn)||this.track.insertEventAtTime(this.noteOn),this.track.hasEvent(this.noteOff)||
this.track.insertEventAtTime(this.noteOff),this.track.insertNoteAtTime(this))};var b=function(){this.end=this.noteOff.time;this.start=this.noteOn.time;this.velocity=this.noteOn.velocity;this.noteNumber=this.noteOn.noteNumber;this.length=this.noteOff.time-this.noteOn.time};d.Note.prototype={adjustTime:function(a){this.track.adjustEventTime(this.noteOn,a);this.track.adjustEventTime(this.noteOff,a);this.track.positionNote(this);b.call(this)},adjustLength:function(a){this.track.adjustEventTime(this.noteOff,
a);b.call(this)},adjustNoteNumber:function(a){this.setNoteNumber(this.noteNumber+a)},setTime:function(a){this.adjustTime(a-this.start)},setNoteNumber:function(a){this.noteOn.noteNumber=a;this.noteNumber=this.noteOff.noteNumber=a},setVelocity:function(a){this.velocity=this.noteOn.velocity=a},setChannel:function(a){d.Util.inRange(a,0,15)&&(this.noteOn.channel=a,this.channel=this.noteOff.channel=a)},remove:function(){null!==this.track&&(this.track.removeEvent(this.noteOn),this.track.removeEvent(this.noteOff),
this.track.removeNote(this))}};d.Emitter&&d.Emitter.register(d.Note);return d}(jMID||{}),jMID=function(d){d.Stream=function(b){this.index=0;this.string=b};d.Stream.prototype={read:function(b){var a=this.string.substr(this.index,b);this.index+=b;return a},readInt32:function(){var b=this.string,a=this.index,b=(b.charCodeAt(a)<<24)+(b.charCodeAt(a+1)<<16)+(b.charCodeAt(a+2)<<8)+b.charCodeAt(a+3);this.index+=4;return b},readInt16:function(){var b=this.string,a=this.index,b=(b.charCodeAt(a)<<8)+b.charCodeAt(a+
1);this.index+=2;return b},readInt8:function(b){var a=this.string.charCodeAt(this.index);this.index+=1;return b&&127<a?a-256:a},eof:function(){return this.index>=this.string.length},readVarInt:function(){for(var b=0;;){var a=this.readInt8();if(a&128)b+=a&127,b<<=7;else return b+a}}};d.Emitter&&d.Emitter.register(d.Stream);return d}(jMID||{}),jMID=function(){jMID.Encoder=function(){};jMID.Encoder.prototype={encode:function(d){for(var b="",a=d.getHeader(),c=jMID.Util,b=b+"MThd\x00\x00\x00\u0006"+(0===
a.format?"\x00\x00":"\x00\u0001"),b=b+c.bytesToString(c.stringToBytes(a.trackCount.toString(),2)),b=b+c.bytesToString([a.ticksPerBeat>>8,a.ticksPerBeat&255]),a=0,c=d.tracks.length;a<c;a++)var h=d.tracks[a].encode(),b=b+h;return b}};jMID.Emitter&&jMID.Emitter.register(jMID.Encoder);return jMID}(jMID||{}),jMID=function(d){var b=function(a,b){var e=new d.Event({track:b});e.set("deltaTime",a.readVarInt());var g=a.readInt8(),f=d.EventTypes;if(240==(g&240))switch(g){case f.META:e.set("type","meta");var i=
a.readInt8(),g=a.readVarInt(),f=d.SubEventTypes,l;for(l in f){var j=f[l];if(i==j){switch(j){case f.SEQUENCE_NUMBER:e.set("number",a.readInt16());break;case f.MIDI_CHANNEL_PREFIX:e.set("channel",a.readInt8());break;case f.SET_TEMPO:e.set("microsecondsPerBeat",(a.readInt8()<<16)+(a.readInt8()<<8)+a.readInt8());e.set("subtype","setTempo");break;case f.SMPTE_OFFSET:i=a.readInt8();e.set({hourByte:i,frameRate:{"0":24,32:25,64:29,96:30}[i&96],hour:i&31,min:a.readInt8(),sec:a.readInt8(),frame:a.readInt8(),
subframe:a.readInt8(),subtype:"smpteOffset"});break;case f.TIME_SIGNATURE:e.set({numerator:a.readInt8(),denominator:Math.pow(2,a.readInt8()),metronome:a.readInt8(),thirtyseconds:a.readInt8(),subtype:"timeSignature"});break;case f.KEY_SIGNATURE:e.set({key:a.readInt8(!0),scale:a.readInt8(),subtype:"keySignature"});break;case f.TEXT:e.set({subtype:"text",text:a.read(g)});break;case f.COPYRIGHT_NOTICE:e.set({subtype:"copyrightNotice",text:a.read(g)});break;case f.TRACK_NAME:e.set({subtype:"trackName",
text:a.read(g)});break;case f.INSTRUMENT_NAME:e.set({subtype:"instrumentName",text:a.read(g)});break;case f.LYRICS:e.set({subtype:"lyrics",text:a.read(g)});break;case f.MARKER:e.set({subtype:"marker",text:a.read(g)});break;case f.CUE_POINT:e.set({subtype:"cuePoint",text:a.read(g)});break;case f.END_OF_TRACK:e.set("subtype","endOfTrack");break;case f.SEQUENCER_SPECIFIC:e.set({subtype:"sequencerSpecific",data:a.read(g)});break;default:e.set({subtype:"unknown",data:a.read(g)})}break}}break;case f.SYSEX:e.set("type",
"sysex");i=a.readVarInt();e.set("data",a.read(i));break;case f.DIVIDED_SYSEX:event.set("type","dividedSysex");i=stream.readVarInt();event.set("data",stream.read(i));break;default:throw Error("Unrecognized event");}else for(i in j=g,g=d.SubEventTypes,0==(j&128)?(l=j,j=this._lastEventType):(l=a.readInt8(),this._lastEventType=j),f=j>>4,e.set("channel",j&15),e.set("type","channel"),g)if(j=g[i],f==j)switch(j){case g.NOTE_OFF:e.set("noteNumber",l);e.set("subtype","noteOff");e.set("velocity",a.readInt8());
break;case g.NOTE_ON:e.set("noteNumber",l);e.set("subtype","noteOn");e.set("velocity",a.readInt8());0==e.get("velocity")&&e.set("subtype","noteOff");break;case g.NOTE_AFTER_TOUCH:e.set("noteNumber",l);e.set("subtype","noteAfterTouch");e.set("amount",a.readInt8());break;case g.CONTROLLER:e.set("subtype","controller");e.set("controllerType",l);e.set("value",a.readInt8());break;case g.PROGRAM_CHANGE:e.set("subtype","programChange");e.set("programNumber",l);break;case g.CHANNEL_AFTER_TOUCH:e.set("subtype",
"channelAfterTouch");e.set("amount",l);break;case g.PITCH_BEND:e.set("subtype","pitchBend"),e.set("coarse",l),e.set("fine",a.readInt8()),e.set("value",e.coarse+(e.fine<<7))}return e},a=function(a){var b=a.read(4),d=a.readInt32();return{id:b,length:d,data:a.read(d)}};d.Decoder=function(){};d.Decoder.prototype={decode:function(c){for(var h=a(c),e=new d.Stream(h.data),g=e.readInt16(),h=e.readInt16(),f=e.readInt16(),e=[],g={format:g,trackCount:h,ticksPerBeat:f},f=0;f<h;f++){e[f]=new d.Track;for(var i=
a(c),i=new d.Stream(i.data);!i.eof();)e[f].pushEvent(b.call(this,i,e[f]))}return new d.File({header:g,tracks:e})}};d.Emitter&&d.Emitter.register(d.Decoder);return d}(jMID||{}),jMID=function(d){var b=function(a){var b;if(a){b=a.split(",").map(function(a){return a.trim()});for(var c=[],e=0,j=b.length;e<j;e++)c.push(b[e].split(" "));b=c}else b=void 0;c=[];e=0;for(j=this._results.tracks.length;e<j;e++){var h=this._results.tracks[e];c.push(new d.Track({timing:h.timing}));var m=this.noteSearch?h.getNotes():
h.getEvents();if(a)for(var r=0,m=m.length;r<m;r++)for(var o=this.noteSearch?h.getNotes(r):h.getEvents(r),p=!0,t=0,w=b.length;t<w;t++){for(var u=b[t],s=0,x=u.length;s<x;s++){var q;a:{q=u[s];for(var n=[":",">",">=","<","<="],k=n.length-1;0<=k;k--)if(-1!==q.search(n[k])){q=n[k];break a}q=void 0}k=u[s].split(q);n=k[0];k=k[1];switch(q){case ":":p=o[n]==k;break;case ">":p=o[n]>k;break;case ">=":p=o[n]>=k;break;case "<":p=o[n]<k;break;case "<=":p=o[n]<=k}if(!p)break}p&&(this.noteSearch?c[e].pushNote(o):
c[e].pushEvent(o))}else c[e]=h}return{tracks:c}},a=function(a,b,c){this.noteSearch=c;this._results=b?b:{tracks:a.tracks.slice(0)};this._file=a};a.prototype={filter:function(c){c=b.call(this,c);return new a(this._file,c,this.noteSearch)},not:function(c){for(var c=b.call(this,c),f=this._results,e=[],h=0,j=f.tracks.length;h<j;h++){var v=f.tracks[h],m=new d.Track;this.noteSearch?(m.notes=v.cloneNotes(),m.removeNotes.apply(m,c.tracks[h].getNotes())):(m.events=v.cloneEvents(),m.removeEvents.apply(m,c.tracks[h].getEvents()));
e.push(m)}return new a(this._file,{tracks:e},this.noteSearch)},toArray:function(){for(var a=[],b=0,c=this._results.tracks.length;b<c;b++)var d=this._results.tracks[b],a=a.concat(this.noteSearch?d.notes:d.events);return a},increment:function(a,b){d.Util[this.noteSearch?"forAllNotes":"forAllEvents"](this._results.tracks,function(c){a in c&&(c[a]+=b)});return this},set:function(a,b){d.Util[this.noteSearch?"forAllNotes":"forAllEvents"](this._results.tracks,function(c){a in c&&(c[a]=b)});return this},
get:function(a,b){return this._results.tracks[a].events[b]},eq:function(b,c){return new a(this._file,{tracks:[new d.Track({events:[this.get.apply(this,arguments)],timing:b.timing})]})},encodeEvents:function(a){var b=[];d.Util.forAllEvents(this._results.tracks,function(c,e,h){b[h]||(b[h]=[]);b[h].push(!a?d.Util.bytesToString(c.encode()):c.encode())});return b},encodeTracks:function(a){var b=[];d.Util.forEachTrack(this._results.tracks,function(c,e){b[e]||(b[e]=[]);b[e].push(!a?c.encode():d.Util.stringToBytes(c.encode()))});
return b},notes:function(c){this.noteSearch=!0;c=b.call(this,c);return new a(this._file,c,!0)},remove:function(){d.Util[this.noteSearch?"forAllNotes":"forAllEvents"](this._results.tracks,function(a){a.remove()});return new a(this._file,{tracks:this._file.tracks.slice(0)},this.noteSearch)},apply:function(){if(this.noteSearch)return this;for(var b=0,c=this._results.tracks.length;b<c;b++)this._file.tracks[b]=new d.Track({events:this._results.tracks[b].cloneEvents(),timing:this._file.tracks[b].timing});
return new a(this._file)}};for(var c="adjustNoteNumber adjustTime adjustLength setNoteNumber setVelocity setChannel".split(" "),h=0,e=c.length;h<e;h++)(function(b){a.prototype[b]=function(a){if(!this.noteSearch)return this;d.Util.forAllNotes(this._results.tracks,function(c){c[b](a)});return this}})(c[h]);d.Query=function(b){if(!b&&!b instanceof d.File)throw Error("jMID.File is needed for querying");return new a(b)};d.Emitter&&d.Emitter.register(d.Query);return d}(jMID||{}),jMID=function(d){var b=
"C C# D D# E F F# G G# A A# B".split(" ");d.Converter={_type:0,noteToFrequency:function(a){return 0<=a&&127>=a?440*Math.pow(2,(a-69)/12):-1},noteToName:function(a){return NaN===parseInt(a,10)?a:0<=a&&127>=a?this.Notes[a]:"---"},frequencyToNote:function(a){return Math.round(12*(Math.log(a/440)/Math.log(2)))+69},nameToNote:function(a){return this.Notes.indexOf(a)},convert:function(a){switch(this._type){case 0:return this.noteToFrequency(a);case 1:return this.noteToName(a);case 2:return this.frequencyToNote(a);
case 3:return this.nameToNote(a)}},setType:function(a){this._type=a}};for(var a=d.Converter,c=0,h=0,e=[],g=b.length;128>c;)e[c]=b[h]+Math.floor(c/12),h++,h>=g&&(h=0),c++;a.Notes=e;d.Converter.Types={NOTE_TO_FREQUENCY:0,NOTE_TO_NAME:1,FREQUENCY_TO_NOTE:2,NAME_TO_NOTE:3};return d}(jMID||{}),jMID=function(d){var b=function(a){this.events=a;this.queue=[];this.nextEvent=null};b.prototype={setQueue:function(a){this.queue=this.events.filter(function(b){return b.time>=a})},queueNext:function(){this.queue.shift();
this.nextEvent=this.queue.length?this.queue[0]:null},getNextEvent:function(){return this.nextEvent},triggerEvent:function(){this.trigger("eventTriggered",this.nextEvent);this.queueNext()},checkEvent:function(a){1>this.queue.length&&this.trigger("queueEmpty");null!==this.nextEvent&&a>=this.nextEvent.time&&this.triggerEvent()}};d.Emitter.register(b);d.Player=function(a){if(!a.file)throw Error("File is required");this.context=a.context||new webkitAudioContext;this.startTime=this.currentPosition=0;this.needsRequeue=
!0;this.tracks=[];this.schedules=[];this.loop=!1;this.bufferSize=a.bufferSize||512;this.scriptNode=this.context.createScriptProcessor(this.bufferSize,1,1);this.isPlaying=!1;this.onTrackEnd=this.onTrackEnd.bind(this);this.endTimeout;this.timer=new d.AudioTimer(this.context);this.scriptNode.connect(this.context.destination);for(var b in a)a.hasOwnProperty(b)&&(this[b]=a[b]);this.initializeQueues();this.scriptNode.onaudioprocess=this.onAudioProcess.bind(this)};d.Player.prototype={onAudioProcess:function(){this.isPlaying&&
(this.currentPosition=this.getContextTime()-this.startContextTime+this.startPosition)},initializeQueues:function(){this.tracks=[];for(var a=0,c=this.file.tracks.length;a<c;a++)this.tracks.push(new b(this.file.tracks[a].getEvents())),this.tracks[a].setQueue(1E3*this.currentPosition),this.tracks[a].on("eventTriggered",this.onEventTrigger.bind(this)),this.tracks[a].on("queueEmpty",this.onQueueEmpty.bind(this))},onQueueEmpty:function(){for(var a,b=0,d=this.tracks.length;b<d;b++)if(0<this.tracks[b].queue.length){a=
!1;break}else a=!0;a&&(this.trigger("endOfFile"),this.stop(),this.loop&&this.play())},onEventTrigger:function(a){this.trigger("event",a)},addSchedule:function(a){this.schedules.push(a)},removeSchedule:function(a){this.schedules.splice(this.schedules.indexOf(a),1)},scheduleEvents:function(a){var b=this;this.tracks.forEach(function(d){d.setQueue(1E3*b.currentPosition);d.queue.every(function(d){setTimeout(function(){b.isPlaying&&a.call(b,d,d.time/1E3-b.currentPosition+b.getContextTime())},0);return b.isPlaying})})},
queueEvents:function(){for(var a=0,b=this.tracks.length;a<b;a++)this.tracks[a].setQueue(1E3*this.currentPosition)},getContextTime:function(){return this.context.currentTime},getCurrentTime:function(){return this.currentPosition},gotoPosition:function(a){this.currentPosition=a},onTrackEnd:function(){this.stop(this.loop);this.trigger("endOfTrack");this.loop&&(this.trigger("loop"),this.play())},setTempo:function(a){this.file.setTempo(a);this.isPlaying&&(this.pause(),this.play())},setLoop:function(a){this.loop=
a},play:function(){if(!this.isPlaying){this.isPlaying=!0;for(var a=0,b=this.schedules.length;a<b;a++)this.scheduleEvents(this.schedules[a]);this.endOfTrackTime=this.file.duration/1E3-this.currentPosition+this.getContextTime();this.timer.callbackAtTime(this.endOfTrackTime,this.onTrackEnd,this);this.startContextTime=this.getContextTime();this.startPosition=this.currentPosition;this.trigger("play")}},pause:function(){this.isPlaying=!1;this.trigger("pause");this.timer.removeCallbackAtTime(this.onTrackEnd,
this.endOfTrackTime)},stop:function(a){this.timer.removeCallbackAtTime(this.onTrackEnd,this.endOfTrackTime);this.currentPosition=0;this.isPlaying=!1;this.needsRequeue=!0;a||this.trigger("stop")}};d.Emitter.register(d.Player);return d}(jMID||{});
