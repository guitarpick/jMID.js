/**
 * jMID.min.js v0.1
 *
 * A javascript library for reading, manipulating, and writing MIDI files
 * @author Steven Sojka - Thursday, January 31, 2013
 *
 * MIT Licensed
 */
var jMID=function(d){d.EventTypes={META:255,SYSEX:240,DIVIDED_SYSEX:247};d.SubEventTypes={SEQUENCE_NUMBER:0,TEXT:1,COPYRIGHT_NOTICE:2,TRACK_NAME:3,INSTRUMENT_NAME:4,LYRICS:5,MARKER:6,CUE_POINT:7,MIDI_CHANNEL_PREFIX:32,END_OF_TRACK:47,SET_TEMPO:81,SMPTE_OFFSET:84,TIME_SIGNATURE:88,KEY_SIGNATURE:89,SEQUENCER_SPECIFIC:127,NOTE_OFF:8,NOTE_ON:9,NOTE_AFTER_TOUCH:10,CONTROLLER:11,PROGRAM_CHANGE:12,CHANNEL_AFTER_TOUCH:13,PITCH_BEND:14};return d}(jMID||{}),jMID=function(d){var b=Array.prototype;d.Util={isObject:function(e){return e===
Object(e)},asciiToHex:function(e){for(var a="",c=0,b=e.length;c<b;c++)a+=e.charCodeAt(c).toString(16);return a},hexToAscii:function(e){return a},stringToBytes:function(e,a){if(a)for(;e.length/2<a;)e="0"+e;for(var c=[],
b=e.length-1;0<=b;b-=2)c.unshift(parseInt(0===b?e[b]:e[b-1]+e[b],16));return c},writeVarInt:function(e){for(var a=e&127;e>>=7;)a<<=8,a|=e&127|128;for(e=[];;)if(e.push(a&255),a&128)a>>=8;else break;return e},getType:function(a){var c=d.SubEventTypes;switch(a){case "sequenceNumber":return c.SEQUENCER_NUMBER;case "text":return c.TEXT;case "copyrightNotice":return c.COPYRIGHT_NOTICE;case "trackName":return c.TRACK_NAME;case "instrumentName":return c.INSTRUMENT_NAME;case "lyrics":return c.LYRICS;case "marker":return c.MARKER;
case "cuePoint":return c.CUE_POINT;case "midiChannelPrefix":return c.MIDI_CHANNEL_PREFIX;case "endOfTrack":return c.END_OF_TRACK;case "setTempo":return c.SET_TEMPO;case "smpteOffset":return c.SMPTE_OFFSET;case "timeSignature":return c.TIME_SIGNATURE;case "sequencerSpecific":return c.SEQUENCER_SPECIFIC;case "noteOff":return c.NOTE_OFF;case "noteOn":return c.NOTE_ON;case "noteAfterTouch":return c.NOTE_AFTER_TOUCH;case "controller":return c.CONTROLLER;case "programChange":return c.PROGRAM_CHANGE;case "channelAfterTouch":return c.CHANNEL_AFTER_TOUCH;
case "pitchBend":return c.PITCH_BEND}},forAllEvents:function(c,a){var d=this,g=b.slice.call(arguments);g.splice(0,2);this.forEachTrack(c,function(c,e){d.forEachEvent.apply(d,[c,a,e].concat(g))})},forAllNotes:function(c,a){var d=this,g=b.slice.call(arguments);g.splice(0,2);this.forEachTrack(c,function(c,e){d.forEachNote.apply(d,[c,a,e].concat(g))})},forEachTrack:function(c,a){var d=b.slice.call(arguments);d.splice(0,2);for(var g=0,i=c.length;g<i;g++)a.apply(this,[c[g],g].concat(d))},forEachNote:function(c,
a){var d=b.slice.call(arguments);d.splice(0,2);for(var g=0,i=c.notes.length;g<i;g++)a.apply(this,[c.notes[g],g].concat(d))},forEachEvent:function(c,a){var d=b.slice.call(arguments);d.splice(0,2);for(var g=0,i=c.events.length;g<i;g++)a.apply(this,[c.events[g],g].concat(d))},inRange:function(c,a,b){return c>=a&&c<=b}};for(var a="Arguments Function String Number Date RegExp".split(" "),c=a.length-1;0<=c;c--)(function(c){d.Util["is"+c]=function(a){return toString.call(a)=="[object "+c+"]"}})(a[c]);return d}(jMID||
{}),jMID=function(d){d.Emitter=function(){};d.Emitter.prototype={on:function(b,a){this.__events=this.__events||{};this.__events[b]=this.__events[b]||[];this.__events[b].push(a)},off:function(b,a){this.__events=this.__events||{};b in this.__events&&this.__events[b].splice(this.__events[b].indexOf(a),1)},trigger:function(b){this.__events=this.__events||{};if(b in this.__events)for(var a=0,c=this.__events[b].length;a<c;a++)this.__events[b][a].apply(this,Array.prototype.slice.call(arguments,1))}};d.Emitter.register=
function(b){for(var a in d.Emitter.prototype)d.Emitter.prototype.hasOwnProperty(a)&&(b.prototype[a]=d.Emitter.prototype[a])};return d}(jMID||{}),jMID=function(d){d.Event=function(){};d.Event.prototype={set:function(){var b=d.Util,a=arguments;if(b.isObject(a[0]))for(var c in a[0])a[0].hasOwnProperty(c)&&(this[c]=a[0][c]);else if(b.isString(a[0]))this[a[0]]=a[1];else return null},get:function(b){return this[b]},encode:function(){if("meta"===this.type){var b=[];Array.prototype.push.apply(b,d.Util.writeVarInt(this.deltaTime));
b.push(255,d.Util.getType(this.subtype));switch(this.subtype){case "sequenceNumber":b.push(1,this.number);break;case "midiChannelPrefix":b.push(1,this.channel);break;case "setTempo":b.push(3,(this.microsecondsPerBeat&16711680)>>16,(this.microsecondsPerBeat&65280)>>8,this.microsecondsPerBeat&255);break;case "smpteOffset":b.push(5,this.hourByte,this.min,this.sec,this.frame,this.subframe);break;case "timeSignature":b.push(4,this.numerator,Math.log(this.denominator)/Math.log(2),this.metronome,this.thirtyseconds);
break;case "keySignature":b.push(2,this.key,this.scale);break;case "copyrightNotice":case "text":case "trackName":case "instrumentName":case "lyrics":case "marker":case "cuePoint":var a=this.text.split("");Array.prototype.push.apply(b,[a.length].concat(a));break;case "sequencerSpecific":case "unknown":b.push(1,this.data);break;case "endOfTrack":b.push(0)}return b}b=[];a=d.Util.getType(this.subtype);a=parseInt(a.toString(16)+this.channel.toString(16),16);Array.prototype.push.apply(b,d.Util.writeVarInt(this.deltaTime));
b.push(a);switch(this.subtype){case "noteOn":case "noteOff":b.push(this.noteNumber,this.velocity);break;case "noteAfterTouch":b.push(this.noteNumber,this.amount);break;case "controller":b.push(this.controllerType,this.value);break;case "programChange":byteArry.push(this.programNumber);break;case "channelAfterTouch":b.push(this.amount);break;case "pitchBend":b.push(this.course,this.fine)}return b}};d.Emitter&&d.Emitter.register(d.Event);return d}(jMID||{}),jMID=function(d){var b=function(a){for(var c,
e=Array.prototype.slice.call(arguments,1),b=e.length,d;b&&this[a].length;)for(c=e[--b];-1!==(d=this[a].indexOf(c));)this[a].splice(d,1);return this};d.Track=function(a){this.events=[];this.notes=[];for(var c in a)a.hasOwnProperty(c)&&(this[c]=a[c]);this.processNotes()};d.Track.prototype={pushEvent:function(a){this.events.push(a);return this},pushNote:function(a){this.notes.push(a);return this},getEvents:function(a){return"undefined"!==typeof a?0<=a&&a<this.events.length?this.events[a]:null:this.events},
getNotes:function(a){return"undefined"!==typeof a?0<=a&&a<this.notes.length?this.notes[a]:null:this.notes},removeEvents:function(){return b.apply(this,["events"].concat(Array.prototype.slice.call(arguments)))},removeNotes:function(){return b.apply(this,["notes"].concat(Array.prototype.slice.call(arguments)))},cloneEvents:function(){return this.events.slice(0)},cloneNotes:function(){return this.notes.slice(0)},encode:function(){for(var a=[],c=0,e=0,b=this.events.length;e<b;e++){var f=this.getEvents(e).encode(),
c=c+f.length;Array.prototype.push.apply(a,f)}c=d.Util.stringToBytes(c.toString(16),4);return d.Util.bytesToString([77,84,114,107].concat(c,a))},adjustEventTime:function(a,c){var a=d.Util.isNumber(a)?this.events[a]:a,e=this.events.indexOf(a),b=this.events[e+1];Math.round(c/this.timing.MSPT);var f;a.time+=c;this.events.splice(e,1);for(var e=0,g=this.events.length;e<g;e++)if(!(a.time>=this.events[e].time)){this.events.splice(e,0,a);f=e;break}this.calculateDelta(b,a,this.events[f+1])},calculateDelta:function(){for(var a=
Array.prototype.slice.call(arguments),c=0,e=a.length;c<e;c++){var b=a[c],d=this.events.indexOf(b),d=this.events[d-1];b.deltaTime=d?Math.round((b.time-d.time)/this.timing.MSPT):Math.round(b.time/this.timing.MSPT)}},switchEvents:function(a,c){var b=this.events.indexOf(a),d=this.events.indexOf(c);this.events.splice(d,1,a);this.events.splice(b,1,c)},processNotes:function(){var a={};this.notes=[];for(var c=0,b=this.events.length;c<b;c++){var h=this.events[c];"noteOn"===h.subtype?a[h.noteNumber]=h:"noteOff"===
h.subtype&&h.noteNumber in a&&(this.notes.push(new d.Note(a[h.noteNumber],h,this)),delete a[h.noteNumber])}},processChannelEventTimes:function(){for(var a=this.timing.MSPT,c=0,b=0,d=this.events.length;b<d;b++){var f=this.events[b],g=f.deltaTime*a;f.set("time",c+g);c+=g}}};d.Emitter&&d.Emitter.register(d.Track);return d}(jMID||{}),jMID=function(d){d.File=function(b){for(var a in b)b.hasOwnProperty(a)&&(this[a]=b[a]);this.timeSignature={beatsPerBar:4,beatValue:4};this.timing={MicroSPB:5E5};this.processMetaEvents();
for(b=this.tracks.length-1;0<=b;b--)this.tracks[b].timing=this.timing;this.processChannelEventTimes();this.processNotes()};d.File.prototype={processMetaEvents:function(){for(var b=d.Query(this).filter("type:meta").not("subtype:endOfTrack, subtype:trackName").toArray(),a=0,c=b.length;a<c;a++)switch(b[a].subtype){case "timeSignature":this.timeSignature.beatsPerBar=b[a].numerator;this.timeSignature.beatValue=b[a].denominator;break;case "setTempo":this.timing.MicroSPB=b[a].microsecondsPerBeat}this.calculateBPM();
this.timing.MSPQN=this.timing.MicroSPB/1E3;this.timing.MSPT=this.timing.MSPQN/this.header.ticksPerBeat},processChannelEventTimes:function(){for(var b=0,a=this.tracks.length;b<a;b++)this.tracks[b].processChannelEventTimes()},processNotes:function(){for(var b=0,a=this.tracks.length;b<a;b++)this.tracks[b].processNotes()},calculateBPM:function(){this.timing.BPM=6E7/this.timing.MicroSPB*(this.timeSignature.beatValue/4)},getTrack:function(b){return this.tracks[b]},getHeader:function(){return this.header},
encode:function(){return(new d.Encoder).encode(this)},base64Encode:function(){return btoa(this.encode())}};d.Emitter&&d.Emitter.register(d.File);return d}(jMID||{}),jMID=function(d){d.Note=function(b,a,c){this.noteOn=b;this.noteOff=a;this.start=b.time;this.end=a.time;this.track=c;this.velocity=b.velocity;this.noteNumber=b.noteNumber;this.length=a.time-b.time};d.Note.prototype={adjustTime:function(b){this.track.adjustEventTime(this.noteOn,b);this.track.adjustEventTime(this.noteOff,b);this.track.processNotes()},
adjustLength:function(b){this.track.adjustEventTime(this.noteOff,b);this.length=this.noteOff.time-this.noteOn.time;this.end=this.noteOff.time},adjustNoteNumber:function(b){this.setNoteNumber(this.noteNumber+b)},setNoteNumber:function(b){this.noteOn.noteNumber=b;this.noteNumber=this.noteOff.noteNumber=b},setVelocity:function(b){this.velocity=this.noteOn.velocity=b},setChannel:function(b){d.Util.inRange(b,0,15)&&(this.noteOn.channel=b,this.noteOff.channel=b)}};d.Emitter&&d.Emitter.register(d.Note);
return d}(jMID||{}),jMID=function(d){d.Stream=function(b){this.index=0;this.string=b};d.Stream.prototype={read:function(b){var a=this.string.substr(this.index,b);this.index+=b;return a},readInt32:function(){var b=this.string,a=this.index,b=(b.charCodeAt(a)<<24)+(b.charCodeAt(a+1)<<16)+(b.charCodeAt(a+2)<<8)+b.charCodeAt(a+3);this.index+=4;return b},readInt16:function(){var b=this.string,a=this.index,b=(b.charCodeAt(a)<<8)+b.charCodeAt(a+1);this.index+=2;return b},readInt8:function(b){var a=this.string.charCodeAt(this.index);
this.index+=1;return b&&127<a?a-256:a},eof:function(){return this.index>=this.string.length},readVarInt:function(){for(var b=0;;){var a=this.readInt8();if(a&128)b+=a&127,b<<=7;else return b+a}}};d.Emitter&&d.Emitter.register(d.Stream);return d}(jMID||{}),jMID=function(){jMID.Encoder=function(){};jMID.Encoder.prototype={encode:function(d){for(var b="",a=d.getHeader(),c=jMID.Util,b=b+"MThd\x00\x00\x00\u0006"+(0===a.format?"\x00\x00":"\x00\u0001"),b=b+c.bytesToString(c.stringToBytes(a.trackCount.toString(),
2)),b=b+c.bytesToString([a.ticksPerBeat>>8,a.ticksPerBeat&255]),a=0,c=d.tracks.length;a<c;a++)var e=d.tracks[a].encode(),b=b+e;return b}};jMID.Emitter&&jMID.Emitter.register(jMID.Encoder);return jMID}(jMID||{}),jMID=function(d){var b=function(c){var a=new d.Event;a.set("deltaTime",c.readVarInt());var b=c.readInt8(),f=d.EventTypes;if(240==(b&240))switch(b){case f.META:a.set("type","meta");var g=c.readInt8(),b=c.readVarInt(),f=d.SubEventTypes,i;for(i in f){var j=f[i];if(g==j){switch(j){case f.SEQUENCE_NUMBER:a.set("number",
c.readInt16());break;case f.MIDI_CHANNEL_PREFIX:a.set("channel",c.readInt8());break;case f.SET_TEMPO:a.set("microsecondsPerBeat",(c.readInt8()<<16)+(c.readInt8()<<8)+c.readInt8());a.set("subtype","setTempo");break;case f.SMPTE_OFFSET:g=c.readInt8();a.set({hourByte:g,frameRate:{"0":24,32:25,64:29,96:30}[g&96],hour:g&31,min:c.readInt8(),sec:c.readInt8(),frame:c.readInt8(),subframe:c.readInt8(),subtype:"smpteOffset"});break;case f.TIME_SIGNATURE:a.set({numerator:c.readInt8(),denominator:Math.pow(2,c.readInt8()),
metronome:c.readInt8(),thirtyseconds:c.readInt8(),subtype:"timeSignature"});break;case f.KEY_SIGNATURE:a.set({key:c.readInt8(!0),scale:c.readInt8(),subtype:"keySignature"});break;case f.TEXT:a.set({subtype:"text",text:c.read(b)});break;case f.COPYRIGHT_NOTICE:a.set({subtype:"copyrightNotice",text:c.read(b)});break;case f.TRACK_NAME:a.set({subtype:"trackName",text:c.read(b)});break;case f.INSTRUMENT_NAME:a.set({subtype:"instrumentName",text:c.read(b)});break;case f.LYRICS:a.set({subtype:"lyrics",text:c.read(b)});
break;case f.MARKER:a.set({subtype:"marker",text:c.read(b)});break;case f.CUE_POINT:a.set({subtype:"cuePoint",text:c.read(b)});break;case f.END_OF_TRACK:a.set("subtype","endOfTrack");break;case f.SEQUENCER_SPECIFIC:a.set({subtype:"sequencerSpecific",data:c.read(b)});break;default:a.set({subtype:"unknown",data:c.read(b)})}break}}break;case f.SYSEX:a.set("type","sysex");g=c.readVarInt();a.set("data",c.read(g));break;case f.DIVIDED_SYSEX:event.set("type","dividedSysex");c=stream.readVarInt();event.set("data",
stream.read(c));break;default:throw Error("Unrecognized event");}else for(g in j=b,b=d.SubEventTypes,0==(j&128)?(i=j,j=this._lastEventType):(i=c.readInt8(),this._lastEventType=j),f=j>>4,a.set("channel",j&15),a.set("type","channel"),b)if(j=b[g],f==j)switch(j){case b.NOTE_OFF:a.set("noteNumber",i);a.set("subtype","noteOff");a.set("velocity",c.readInt8());break;case b.NOTE_ON:a.set("noteNumber",i);a.set("subtype","noteOn");a.set("velocity",c.readInt8());0==a.get("velocity")&&a.set("subtype","noteOff");
break;case b.NOTE_AFTER_TOUCH:a.set("noteNumber",i);a.set("subtype","noteAfterTouch");a.set("amount",c.readInt8());break;case b.CONTROLLER:a.set("subtype","controller");a.set("controllerType",i);a.set("value",c.readInt8());break;case b.PROGRAM_CHANGE:a.set("subtype","programChange");a.set("programNumber",i);break;case b.CHANNEL_AFTER_TOUCH:a.set("subtype","channelAfterTouch");a.set("amount",i);break;case b.PITCH_BEND:a.set("subtype","pitchBend"),a.set("coarse",i),a.set("fine",c.readInt8()),a.set("value",
a.coarse+(a.fine<<7))}return a},a=function(a){var b=a.read(4),d=a.readInt32();return{id:b,length:d,data:a.read(d)}};d.Decoder=function(){};d.Decoder.prototype={decode:function(c){for(var e=a(c),h=new d.Stream(e.data),f=h.readInt16(),e=h.readInt16(),g=h.readInt16(),h=[],f={format:f,trackCount:e,ticksPerBeat:g},g=0;g<e;g++){h[g]=new d.Track;for(var i=a(c),i=new d.Stream(i.data);!i.eof();)h[g].pushEvent(b.call(this,i))}return new d.File({header:f,tracks:h})}};d.Emitter&&d.Emitter.register(d.Decoder);
return d}(jMID||{}),jMID=function(d){var b=function(a){var b;if(a){b=a.split(",").map(function(a){return a.trim()});for(var h=[],f=0,g=b.length;f<g;f++)h.push(b[f].split(" "));b=h}else b=void 0;h=[];f=0;for(g=this._results.tracks.length;f<g;f++){var i=this._results.tracks[f];h.push(new d.Track({timing:i.timing}));var j=this.noteSearch?i.getNotes():i.getEvents();if(a)for(var p=0,j=j.length;p<j;p++)for(var m=this.noteSearch?i.getNotes(p):i.getEvents(p),n=!0,r=0,t=b.length;r<t;r++){for(var s=b[r],q=
0,u=s.length;q<u;q++){var o;a:{o=s[q];for(var l=[":",">",">=","<","<="],k=l.length-1;0<=k;k--)if(-1!==o.search(l[k])){o=l[k];break a}o=void 0}k=s[q].split(o);l=k[0];k=k[1];switch(o){case ":":n=m[l]==k;break;case ">":n=m[l]>k;break;case ">=":n=m[l]>=k;break;case "<":n=m[l]<k;break;case "<=":n=m[l]<=k}if(!n)break}n&&(this.noteSearch?h[f].pushNote(m):h[f].pushEvent(m))}else h[f]=i}return{tracks:h}},a=function(a,b,d){this.noteSearch=d;this._results=b?b:{tracks:a.tracks.slice(0)};this._file=a};a.prototype=
{filter:function(c){c=b.call(this,c);return new a(this._file,c,this.noteSearch)},not:function(c){for(var c=b.call(this,c),e=this._results,h=[],f=0,g=e.tracks.length;f<g;f++){var i=e.tracks[f],j=new d.Track;this.noteSearch?(j.notes=i.cloneNotes(),j.removeNotes.apply(j,c.tracks[f].getNotes())):(j.events=i.cloneEvents(),j.removeEvents.apply(j,c.tracks[f].getEvents()));h.push(j)}return new a(this._file,{tracks:h},this.noteSearch)},toArray:function(){for(var a=[],b=0,d=this._results.tracks.length;b<d;b++)var f=
this._results.tracks[b],a=a.concat(this.noteSearch?f.notes:f.events);return a},increment:function(a,b){d.Util[this.noteSearch?"forAllNotes":"forAllEvents"](this._results.tracks,function(d){a in d&&(d[a]+=b)});return this},set:function(a,b){d.Util[this.noteSearch?"forAllNotes":"forAllEvents"](this._results.tracks,function(d){a in d&&(d[a]=b)});return this},get:function(a,b){return this._results.tracks[a].events[b]},eq:function(b,e){return new a(this._file,{tracks:[new d.Track({events:[this.get.apply(this,
arguments)],timing:b.timing})]})},encodeEvents:function(a){var b=[];d.Util.forAllEvents(this._results.tracks,function(h,f,g){b[g]||(b[g]=[]);b[g].push(!a?d.Util.bytesToString(h.encode()):h.encode())});return b},encodeTracks:function(a){var b=[];d.Util.forEachTrack(this._results.tracks,function(h,f){b[f]||(b[f]=[]);b[f].push(!a?h.encode():d.Util.stringToBytes(h.encode()))});return b},notes:function(c){this.noteSearch=!0;c=b.call(this,c);return new a(this._file,c,!0)},adjustTime:function(a){if(!this.noteSearch)return this;
d.Util.forAllNotes(this._results.tracks,function(b){b.adjustTime(a)});return this},adjustNoteNumber:function(a){if(!this.noteSearch)return this;d.Util.forAllNotes(this._results.tracks,function(b){b.adjustNoteNumber(a)});return this},apply:function(){if(this.noteSearch)return this;for(var b=0,e=this._results.tracks.length;b<e;b++)this._file.tracks[b]=new d.Track({events:this._results.tracks[b].cloneEvents(),timing:this._file.tracks[b].timing});return new a(this._file)}};d.Query=function(b){if(!b&&
!b instanceof d.File)throw Error("jMID.File is needed for querying");return new a(b)};d.Emitter&&d.Emitter.register(d.Query);return d}(jMID||{}),jMID=function(d){var b="C ;C#;D ;D#;E ;F ;F#;G ;G#;A ;A#;B ".split(";");d.Converter=function(){this.setType(d.Converter.Types.NOTE_TO_FREQUENCY)};d.Converter.prototype={noteToFrequency:function(a){return 0<=a&&119>=a?440*Math.pow(2,(a-69)/12):-1},noteToName:function(a){return 0<=a&&119>=a?(b[a%12]+Math.round(a/12).toString()).replace(/\s+/g,""):"---"},frequencyToNote:function(a){return Math.round(12*
(Math.log(a/440)/Math.log(2)))+69},nameToNote:function(a){var c,d,h;if(2===a.length)d=a[0]+" "+a[1];else if(2<a.length)return-1;d.toUpperCase();a=-1;c=0;for(h=b.length;c<h;c++)if(b[c]===d[0]+d[1]){a=c;break}try{return c=parseInt(d[2],10),12*c+a}catch(f){return-1}},convert:function(a){switch(this._type){case 0:return this.noteToFrequency(a);case 1:return this.noteToName(a);case 2:return this.frequencyToNote(a);case 3:return this.nameToNote(a)}},setType:function(a){this._type=a}};d.Converter.Types=
{NOTE_TO_FREQUENCY:0,NOTE_TO_NAME:1,FREQUENCY_TO_NOTE:2,NAME_TO_NOTE:3};d.Emitter&&d.Emitter.register(d.Converter);return d}(jMID||{});
