var jMID=function(e){var c=Array.prototype;e.Util={isObject:function(d){return d===Object(d)},asciiToHex:function(d){for(var i="",a=0,b=d.length;a<b;a++)i+=d.charCodeAt(a).toString(16);return i},hexToAscii:function(d){console.log(d);for(var a="",b=0,c=d.length;b<c;b++)a+=String.fromCharCode(parseInt(d.substr(b,2),16)),d[b];return a},hexToBinary:function(d){return d.toString(2)},bytesToString:function(d){for(var a="",b=0,c=d.length;b<c;b++)a=e.Util.isString(d[b])?a+d[b]:a+String.fromCharCode(d[b]);
return a},stringToBytes:function(d,a){if(a)for(;d.length/2<a;)d="0"+d;for(var b=[],c=d.length-1;0<=c;c-=2)b.unshift(parseInt(0===c?d[c]:d[c-1]+d[c],16));return b},writeVarInt:function(d){for(var a=d&127;d>>=7;)a<<=8,a|=d&127|128;for(d=[];;)if(d.push(a&255),a&128)a>>=8;else break;return d},getType:function(d){var a=e.SubEventTypes;switch(d){case "sequenceNumber":return a.SEQUENCER_NUMBER;case "text":return a.TEXT;case "copyrightNotice":return a.COPYRIGHT_NOTICE;case "trackName":return a.TRACK_NAME;
case "instrumentName":return a.INSTRUMENT_NAME;case "lyrics":return a.LYRICS;case "marker":return a.MARKER;case "cuePoint":return a.CUE_POINT;case "midiChannelPrefix":return a.MIDI_CHANNEL_PREFIX;case "endOfTrack":return a.END_OF_TRACK;case "setTempo":return a.SET_TEMPO;case "smpteOffset":return a.SMPTE_OFFSET;case "timeSignature":return a.TIME_SIGNATURE;case "sequencerSpecific":return a.SEQUENCER_SPECIFIC;case "noteOff":return a.NOTE_OFF;case "noteOn":return a.NOTE_ON;case "noteAfterTouch":return a.NOTE_AFTER_TOUCH;
case "controller":return a.CONTROLLER;case "programChange":return a.PROGRAM_CHANGE;case "channelAfterTouch":return a.CHANNEL_AFTER_TOUCH;case "pitchBend":return a.PITCH_BEND}},forAllEvents:function(a,b){var e=this,f=c.slice.call(arguments);f.splice(0,2);this.forEachTrack(a,function(a,d){e.forEachEvent.apply(e,[a,b,d].concat(f))})},forEachTrack:function(a,b){var e=c.slice.call(arguments);e.splice(0,2);for(var f=0,g=a.length;f<g;f++)b.apply(this,[a[f],f].concat(e))},forEachEvent:function(a,b){var e=
c.slice.call(arguments);e.splice(0,2);for(var f=0,g=a.events.length;f<g;f++)b.apply(this,[a.events[f],f].concat(e))}};for(var b="Arguments Function String Number Date RegExp".split(" "),a=b.length-1;0<=a;a--)(function(a){e.Util["is"+a]=function(b){return toString.call(b)=="[object "+a+"]"}})(b[a]);return e}(jMID||{}),jMID=function(e){e.EventTypes={META:255,SYSEX:240,DIVIDED_SYSEX:247};e.SubEventTypes={SEQUENCE_NUMBER:0,TEXT:1,COPYRIGHT_NOTICE:2,TRACK_NAME:3,INSTRUMENT_NAME:4,LYRICS:5,MARKER:6,CUE_POINT:7,
MIDI_CHANNEL_PREFIX:32,END_OF_TRACK:47,SET_TEMPO:81,SMPTE_OFFSET:84,TIME_SIGNATURE:88,KEY_SIGNATURE:89,SEQUENCER_SPECIFIC:127,NOTE_OFF:8,NOTE_ON:9,NOTE_AFTER_TOUCH:10,CONTROLLER:11,PROGRAM_CHANGE:12,CHANNEL_AFTER_TOUCH:13,PITCH_BEND:14};return e}(jMID||{}),jMID=function(e){e.Event=function(){};e.Event.prototype={set:function(){var c=e.Util,b=arguments;if(c.isObject(b[0]))for(var a in b[0])b[0].hasOwnProperty(a)&&(this[a]=b[0][a]);else if(c.isString(b[0]))this[b[0]]=b[1];else return null},get:function(c){return this[c]},
encode:function(){if("meta"===this.type){var c=[];Array.prototype.push.apply(c,e.Util.writeVarInt(this.deltaTime));c.push(255,e.Util.getType(this.subtype));switch(this.subtype){case "sequenceNumber":c.push(1,this.number);break;case "midiChannelPrefix":c.push(1,this.channel);break;case "setTempo":c.push(3,(this.microsecondsPerBeat&16711680)>>16,(this.microsecondsPerBeat&65280)>>8,this.microsecondsPerBeat&255);break;case "smpteOffset":c.push(5,this.hourByte,this.min,this.sec,this.frame,this.subframe);
break;case "timeSignature":c.push(4,this.numerator,Math.log(this.denominator)/Math.log(2),this.metronome,this.thirtyseconds);break;case "keySignature":c.push(2,this.key,this.scale);break;case "copyrightNotice":case "text":case "trackName":case "instrumentName":case "lyrics":case "marker":case "cuePoint":var b=this.text.split("");Array.prototype.push.apply(c,[b.length].concat(b));break;case "sequencerSpecific":case "unknown":c.push(1,this.data);break;case "endOfTrack":c.push(0)}return c}c=[];b=e.Util.getType(this.subtype);
b=parseInt(b.toString(16)+this.channel.toString(16),16);Array.prototype.push.apply(c,e.Util.writeVarInt(this.deltaTime));c.push(b);switch(this.subtype){case "noteOn":case "noteOff":c.push(this.noteNumber,this.velocity);break;case "noteAfterTouch":c.push(this.noteNumber,this.amount);break;case "controller":c.push(this.controllerType,this.value);break;case "programChange":byteArry.push(this.programNumber);break;case "channelAfterTouch":c.push(this.amount);break;case "pitchBend":c.push(this.course,this.fine)}return c}};
return e}(jMID||{}),jMID=function(e){e.Track=function(c){this.events=c||[]};e.Track.prototype={pushEvent:function(c){this.events.push(c);return this},getEvents:function(c){return"undefined"!==typeof c?0<=c&&c<this.events.length?this.events[c]:null:this.events},removeEvents:function(){for(var c,b=arguments,a=b.length,d;a&&this.events.length;)for(c=b[--a];-1!==(d=this.events.indexOf(c));)this.events.splice(d,1);return this},cloneEvents:function(){return this.events.slice(0)},encode:function(){for(var c=
[],b=0,a=0,d=this.events.length;a<d;a++){var i=this.getEvents(a).encode(),b=b+i.length;Array.prototype.push.apply(c,i)}b=e.Util.stringToBytes(b.toString(16),4);return e.Util.bytesToString([77,84,114,107].concat(b,c))}};return e}(jMID||{}),jMID=function(e){e.Stream=function(c){this.index=0;this.string=c};e.Stream.prototype={read:function(c){var b=this.string.substr(this.index,c);this.index+=c;return b},readInt32:function(){var c=this.string,b=this.index,c=(c.charCodeAt(b)<<24)+(c.charCodeAt(b+1)<<
16)+(c.charCodeAt(b+2)<<8)+c.charCodeAt(b+3);this.index+=4;return c},readInt16:function(){var c=this.string,b=this.index,c=(c.charCodeAt(b)<<8)+c.charCodeAt(b+1);this.index+=2;return c},readInt8:function(c){var b=this.string.charCodeAt(this.index);this.index+=1;return c&&127<b?b-256:b},eof:function(){return this.index>=this.string.length},readVarInt:function(){for(var c=0;;){var b=this.readInt8();if(b&128)c+=b&127,c<<=7;else return c+b}}};return e}(jMID||{}),jMID=function(e){e.File=function(c){for(var b in c)c.hasOwnProperty(b)&&
(this[b]=c[b]);this.timeSignature={beatsPerBar:4,beatValue:4};this.timing={MicroSPB:5E5};this.processMetaEvents();this.processChannelEventTimes()};e.File.prototype={processMetaEvents:function(){for(var c=e.Query(this).filter("type:meta").not("subtype:endOfTrack, subtype:trackName").toArray(),b=0,a=c.length;b<a;b++)switch(c[b].subtype){case "timeSignature":this.timeSignature.beatsPerBar=c[b].numerator;this.timeSignature.beatValue=c[b].denominator;break;case "setTempo":this.timing.MicroSPB=c[b].microsecondsPerBeat}this.calculateBPM();
this.timing.MSPQN=this.timing.MicroSPB/1E3;this.timing.MSPT=this.timing.MSPQN/this.header.ticksPerBeat},processChannelEventTimes:function(){for(var c=this.timing.MSPT,b=0,a=this.tracks.length;b<a;b++)for(var d=this.tracks[b],e=0,h=0,f=d.events.length;h<f;h++){var g=d.events[h],j=g.deltaTime*c;g.set("time",e+j);e+=j}},calculateBPM:function(){this.timing.BPM=6E7/this.timing.MicroSPB*(this.timeSignature.beatValue/4)},getHeader:function(){return this.header},encode:function(){return(new e.Encoder).encode(this)},
base64Encode:function(){return btoa(this.encode())}};return e}(jMID||{}),jMID=function(){jMID.Encoder=function(){};jMID.Encoder.prototype={encode:function(e){for(var c="",b=e.getHeader(),a=jMID.Util,c=c+"MThd\x00\x00\x00\u0006"+(0===b.format?"\x00\x00":"\x00\u0001"),c=c+a.bytesToString(a.stringToBytes(b.trackCount.toString(),2)),c=c+a.bytesToString([b.ticksPerBeat>>8,b.ticksPerBeat&255]),b=0,a=e.tracks.length;b<a;b++)var d=e.tracks[b].encode(),c=c+d;return c}};jMID.Encoder.Notes={G9:127,Gb9:126,F9:125,
E9:124,Eb9:123,D9:122,Db9:121,C9:120,B8:119,Bb8:118,A8:117,Ab8:116,G8:115,Gb8:114,F8:113,E8:112,Eb8:111,D8:110,Db8:109,C8:108,B7:107,Bb7:106,A7:105,Ab7:104,G7:103,Gb7:102,F7:101,E7:100,Eb7:99,D7:98,Db7:97,C7:96,B6:95,Bb6:94,A6:93,Ab6:92,G6:91,Gb6:90,F6:89,E6:88,Eb6:87,D6:86,Db6:85,C6:84,B5:83,Bb5:82,A5:81,Ab5:80,G5:79,Gb5:78,F5:77,E5:76,Eb5:75,D5:74,Db5:73,C5:72,B4:71,Bb4:70,A4:69,Ab4:68,G4:67,Gb4:66,F4:65,E4:64,Eb4:63,D4:62,Db4:61,C4:60,B3:59,Bb3:58,A3:57,Ab3:56,G3:55,Gb3:54,F3:53,E3:52,Eb3:51,D3:50,
Db3:49,C3:48,B2:47,Bb2:46,A2:45,Ab2:44,G2:43,Gb2:42,F2:41,E2:40,Eb2:39,D2:38,Db2:37,C2:36,B1:35,Bb1:34,A1:33,Ab1:32,G1:31,Gb1:30,F1:29,E1:28,Eb1:27,D1:26,Db1:25,C1:24,B0:23,Bb0:22,A0:21,Ab0:20,G0:19,Gb0:18,F0:17,E0:16,Eb0:15,D0:14,Db0:13,C0:12};return jMID}(jMID||{}),jMID=function(e){var c=function(a){var d=new e.Event;d.set("deltaTime",a.readVarInt());var b=a.readInt8(),c=e.EventTypes;if(240==(b&240))switch(b){case c.META:d.set("type","meta");var f=a.readInt8(),b=a.readVarInt(),c=e.SubEventTypes,
g;for(g in c){var j=c[g];if(f==j){switch(j){case c.SEQUENCE_NUMBER:d.set("number",a.readInt16());break;case c.MIDI_CHANNEL_PREFIX:d.set("channel",a.readInt8());break;case c.SET_TEMPO:d.set("microsecondsPerBeat",(a.readInt8()<<16)+(a.readInt8()<<8)+a.readInt8());d.set("subtype","setTempo");break;case c.SMPTE_OFFSET:f=a.readInt8();d.set({hourByte:f,frameRate:{"0":24,32:25,64:29,96:30}[f&96],hour:f&31,min:a.readInt8(),sec:a.readInt8(),frame:a.readInt8(),subframe:a.readInt8(),subtype:"smpteOffset"});
break;case c.TIME_SIGNATURE:d.set({numerator:a.readInt8(),denominator:Math.pow(2,a.readInt8()),metronome:a.readInt8(),thirtyseconds:a.readInt8(),subtype:"timeSignature"});break;case c.KEY_SIGNATURE:d.set({key:a.readInt8(!0),scale:a.readInt8(),subtype:"keySignature"});break;case c.TEXT:d.set({subtype:"text",text:a.read(b)});break;case c.COPYRIGHT_NOTICE:d.set({subtype:"copyrightNotice",text:a.read(b)});break;case c.TRACK_NAME:d.set({subtype:"trackName",text:a.read(b)});break;case c.INSTRUMENT_NAME:d.set({subtype:"instrumentName",
text:a.read(b)});break;case c.LYRICS:d.set({subtype:"lyrics",text:a.read(b)});break;case c.MARKER:d.set({subtype:"marker",text:a.read(b)});break;case c.CUE_POINT:d.set({subtype:"cuePoint",text:a.read(b)});break;case c.END_OF_TRACK:d.set("subtype","endOfTrack");break;case c.SEQUENCER_SPECIFIC:d.set({subtype:"sequencerSpecific",data:a.read(b)});break;default:d.set({subtype:"unknown",data:a.read(b)})}break}}break;case c.SYSEX:d.set("type","sysex");f=a.readVarInt();d.set("data",a.read(f));break;case c.DIVIDED_SYSEX:event.set("type",
"dividedSysex");a=stream.readVarInt();event.set("data",stream.read(a));break;default:throw Error("Unrecognized event");}else for(f in j=b,b=e.SubEventTypes,0==(j&128)?(g=j,j=this._lastEventType):(g=a.readInt8(),this._lastEventType=j),c=j>>4,d.set("channel",j&15),d.set("type","channel"),b)if(j=b[f],c==j)switch(j){case b.NOTE_OFF:d.set("noteNumber",g);d.set("subtype","noteOff");d.set("velocity",a.readInt8());break;case b.NOTE_ON:d.set("noteNumber",g);d.set("subtype","noteOn");d.set("velocity",a.readInt8());
0==d.get("velocity")&&d.set("subtype","noteOff");break;case b.NOTE_AFTER_TOUCH:d.set("noteNumber",g);d.set("subtype","noteAfterTouch");d.set("amount",a.readInt8());break;case b.CONTROLLER:d.set("subtype","controller");d.set("controllerType",g);d.set("value",a.readInt8());break;case b.PROGRAM_CHANGE:d.set("subtype","programChange");d.set("programNumber",g);break;case b.CHANNEL_AFTER_TOUCH:d.set("subtype","channelAfterTouch");d.set("amount",g);break;case b.PITCH_BEND:d.set("subtype","pitchBend"),d.set("coarse",
g),d.set("fine",a.readInt8()),d.set("value",d.coarse+(d.fine<<7))}return d},b=function(a){var b=a.read(4),c=a.readInt32();return{id:b,length:c,data:a.read(c)}};e.Decoder=function(){};e.Decoder.prototype={decode:function(a){for(var d=b(a),i=new e.Stream(d.data),h=i.readInt16(),d=i.readInt16(),f=i.readInt16(),i=[],h={format:h,trackCount:d,ticksPerBeat:f},f=0;f<d;f++){i[f]=new e.Track;for(var g=b(a),g=new e.Stream(g.data);!g.eof();)i[f].pushEvent(c.call(this,g))}return new e.File({header:h,tracks:i})}};
return e}(jMID||{}),jMID=function(e){var c=function(a){for(var b=a.split(",").map(function(a){return a.trim()}),a=[],c=0,h=b.length;c<h;c++)a.push(b[c].split(" "));b=[];c=0;for(h=this._results.tracks.length;c<h;c++){var f=this._results.tracks[c];b.push(new e.Track);for(var g=0,j=f.getEvents().length;g<j;g++)for(var n=f.getEvents(g),m=!1,q=0,s=a.length;q<s;q++){for(var r=a[q],p=0,t=r.length;p<t;p++){var o;a:{o=r[p];for(var l=[":",">",">=","<","<="],k=l.length-1;0<=k;k--)if(-1!==o.search(l[k])){o=l[k];
break a}o=void 0}k=r[p].split(o);l=k[0];k=k[1];switch(o){case ":":m=n[l]==k;break;case ">":m=n[l]>k;break;case ">=":m=n[l]>=k;break;case "<":m=n[l]<k;break;case "<=":m=n[l]<=k}if(!m)break}m&&b[c].pushEvent(n)}}return{tracks:b}},b=function(a,b){this._results=b?b:{tracks:a.tracks.slice(0)};this._file=a};b.prototype={filter:function(a){a=c.call(this,a);return new b(this._file,a)},not:function(a){for(var a=c.call(this,a),d=this._results,i=[],h=0,f=d.tracks.length;h<f;h++){var g=new e.Track(d.tracks[h].cloneEvents());
g.removeEvents.apply(g,a.tracks[h].getEvents());i.push(g)}return new b(this._file,{tracks:i})},toArray:function(){for(var a=[],b=0,c=this._results.tracks.length;b<c;b++)a=a.concat(this._results.tracks[b].events);return a},increment:function(a,b){e.Util.forAllEvents(this._results.tracks,function(c){a in c&&(c[a]+=b)});return this},set:function(a,b){e.Util.forAllEvents(this._results.tracks,function(c){a in c&&(c[a]=b)});return this},get:function(a,b){return this._results.tracks[a].events[b]},eq:function(a,
c){return new b(this._file,{tracks:[new e.Track([this.get.apply(this,arguments)])]})},encodeEvents:function(a){var b=[];e.Util.forAllEvents(this._results.tracks,function(c,h,f){b[f]||(b[f]=[]);b[f].push(!a?e.Util.bytesToString(c.encode()):c.encode())});return b},encodeTracks:function(a){var b=[];e.Util.forEachTrack(this._results.tracks,function(c,h){b[h]||(b[h]=[]);b[h].push(!a?c.encode():e.Util.stringToBytes(c.encode()))});return b},apply:function(){for(var a=0,c=this._results.tracks.length;a<c;a++)this._file.tracks[a]=
new e.Track(this._results.tracks[a].cloneEvents());return new b(this._file)}};e.Query=function(a){if(!a&&!a instanceof e.File)throw Error("jMID.File is needed for querying");return new b(a)};return e}(jMID||{}),jMID=function(e){var c="C ;C#;D ;D#;E ;F ;F#;G ;G#;A ;A#;B ".split(";");e.Converter=function(){this.setType(e.Converter.Types.NOTE_TO_FREQUENCY)};e.Converter.prototype={noteToFrequency:function(b){return 0<=b&&119>=b?440*Math.pow(2,(b-69)/12):-1},noteToName:function(b){return 0<=b&&119>=b?
(c[b%12]+Math.round(b/12).toString()).replace(/\s+/g,""):"---"},frequencyToNote:function(b){return Math.round(12*(Math.log(b/440)/Math.log(2)))+69},nameToNote:function(b){var a,d,e;if(2===b.length)d=b[0]+" "+b[1];else if(2<b.length)return-1;d.toUpperCase();b=-1;a=0;for(e=c.length;a<e;a++)if(c[a]===d[0]+d[1]){b=a;break}try{return a=parseInt(d[2],10),12*a+b}catch(h){return-1}},convert:function(b){switch(this._type){case 0:return this.noteToFrequency(b);case 1:return this.noteToName(b);case 2:return this.frequencyToNote(b);
case 3:return this.nameToNote(b)}},setType:function(b){this._type=b}};e.Converter.Types={NOTE_TO_FREQUENCY:0,NOTE_TO_NAME:1,FREQUENCY_TO_NOTE:2,NAME_TO_NOTE:3};return e}(jMID||{});
